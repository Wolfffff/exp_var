---
title: "Expression variation EDA"
output: html_notebook
---

A simple notebook for pulling RNAseq data from Expression Atlas and recount3, merging it together, and filtering it. 

```{r}
library(ExpressionAtlas)
library(tidyverse)
library(limma)
library(sva)
library(edgeR)
library(ggplot2)
library(janitor)


experimental_metadata <- read_csv("expression_atlas_metadata.csv")
# experimental_metadata <- read_csv("recount3_metadata.csv")

feature_vec = list()
feature_vec[["disease"]] = c("normal","control","",NA)
# params = read.csv("experiment_parameters.csv")


# Change the timeout because GTEx is huge!
options(timeout=1800)
```

Pull data as needed

```{r}
# Example pulling from recount3
library(recount3)
human_projects <- available_projects()

proj_info <- subset(
    human_projects,
    project == "SRP166108" & project_type == "data_sources"
)
rse <- create_rse(proj_info)

map_to_cols <- function(s) {
  s %>%
  str_split("\\|", simplify = TRUE) %>% 
  str_split(";;", simplify = TRUE) %>% 
  as_tibble() %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  repair_names()
}

convert_metadata_to_df <- function(sample_attributes) {
  meta <- lapply(sample_attributes,FUN=map_to_cols)
  meta <- dplyr::bind_rows(meta)
  meta <- DataFrame(meta)
  rownames(meta) <-rownames(colData(rse))
  return(meta)
}

metadata_df <- convert_metadata_to_df(colData(rse)$sra.sample_attributes)
rse@colData = metadata_df
```

```{r}
# atlasRes <- searchAtlasExperiments("",species = "Homo sapiens" )
#
accession_ids = experimental_metadata$id

rnaseqExps <- getAtlasData( 
  accession_ids
  # atlasRes$Accession[
  #   grep(
  #     "rna-seq",
  #     atlasRes$Type,
  #     ignore.case = TRUE
  #   )
  # ][1:50]
)

allExps <- rnaseqExps
exps <- names(rnaseqExps@listData)

exp_data = lapply(exps, FUN = function(x){return(allExps[[x]]$rnaseq)})
# exp_data = lapply(exps, FUN = function(x){return(allExps[[x]]$raw_counts)})
names(exp_data) <- exps
```

Generate a data frame containing all counts and another with all the metadata. NAs where metadata is missing.

```{r}
# metadata_df <- data.frame()
# counts_df <- data.frame()

# Feature vectors to sort by

results_list <- list()
results_metadata_list <- list()

for (dset_name in names(exp_data)) {
  print(dset_name)
  dset = exp_data[[dset_name]]
  
  metadata <- colData(dset)
  metadata <- data.frame(metadata)
  
  
  # Append dataset name and seq_id
  # metadata <- cbind(dataset = dset_name,metadata)
  # metadata <- cbind(seq_id = colnames(dset),metadata)

  counts = assays(dset)$counts
  dim(counts)
  
  filtered_metadata <- metadata
  filtered_counts <- as_data_frame(counts)
  for (column in names(feature_vec)) {
    if (column %in% colnames(filtered_metadata)){
      filtered_counts <- filtered_counts[,filtered_metadata[,column] %in% feature_vec[[column]]]
      filtered_metadata <- filtered_metadata[filtered_metadata[,column] %in% feature_vec[[column]],]
    }

  }
  
  metadata <- filtered_metadata
  counts <- filtered_counts
  
  # Make sure we only use variables where there are 2 or more levels and build design matrix to incude
  # everything else
  # metadata <- metadata[!duplicated(metadata),]
  values_count <- sapply(lapply(metadata, unique), length) 
  metadata <- metadata[,names(metadata[,values_count > 1])]


  metadata <- metadata[,!(names(metadata) %in% c("AtlasArrayGroup"))] # Leave this in if you want to remove the AtlasAssayGroup
  print(names(metadata))
  b <- paste0(" ",names(metadata), collapse=" +")
  model <- as.formula(paste0("~ 0 +",b),)

  
  design <- model.matrix(model,data = metadata)
  # design <- design[,-which(colSums(design) == 0)]
  
  
  print("Normalizing and estimating mean-variance weights \n")
  countdata.list <- DGEList(counts=assays(dset)$counts,samples = metadata,genes =rownames(dset))
  countdata.norm <- calcNormFactors(countdata.list)
  
  print("Trimming")
  cutoff <- 1
  drop <- which(apply(cpm(countdata.norm), 1, max) < cutoff)
  countdata.norm <- countdata.norm[-drop,] 
  # mod0 = model.matrix(~0,data=metadata)
  # mod <- design
  # svobj = sva(dat = countdata.norm,mod = design, mod0 = mod0,B=1)
  
  print("Voom!")
  countdata.voom <- voom(countdata.norm, design = design, plot=T)
  # countdata.voom <- countdata.voom[1:1000,] 
  # countdata_resids <- removeBatchEffect(countdata.voom, covariates=design)
  
  # results =  prcomp(t(countdata_resids))
  # jpeg(paste0(dset_name,"_PCA.jpg"))
  # biplot(results)
  # dev.off()
  # 
  # 
  # 
  # jpeg(paste0(dset_name,"_scree.jpg"))
  # var_explained = results$sdev^2 / sum(results$sdev^2)
  # qplot(c(1:10), var_explained[1:10]) +
  #   geom_line() +
  #   xlab("Principal Component") +
  #   ylab("Variance Explained") +
  #   ggtitle("Scree Plot") +
  #   ylim(0, 1)
  # dev.off()
  
  
  print("Appending results and metadata to lists")
  results_list[[dset_name]] = countdata.voom
  results_metadata_list[[dset_name]] = metadata
}
```


```{r}


```
