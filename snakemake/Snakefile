import pandas as pd

configfile: "config.yaml"

input_table = config["metadata"]["recount3"]
IDs = pd.read_csv(input_table).loc[:,"id"].tolist()

datasource = list(config["metadata"].keys())
print(datasource)

rule all:
    input:
        expand("Rdatas/residuals/{ids}.rds", ids=IDs, ds=datasource)

rule download:
    resources: 
        tmpdir="/scratch/tmp"
    params:
        id=IDs
    log:
        "logs/download/{id}.txt"
    input:
        metadata=config["metadata"]["recount3"]
    output:
        "Rdatas/raw/{id}.rds"
    script:
        "scripts/downloadRecount3.R"

rule preProcess:
    resources: 
        tmpdir="/scratch/tmp"
    params:
        id=IDs,
        assay_name="raw_counts"
    log:
        "logs/preProcess/{id}.txt"
    input:
        data="Rdatas/raw/{id}.rds", 
        metadata=config["metadata"]["recount3"]
    output:
        "Rdatas/preProcess/{id}.rds"
    script:
        "scripts/preProcess.R"

rule makeResiduals:
    resources: 
        tmpdir="/scratch/tmp"
    params:
        id=IDs
    log:
        log="logs/makeResiduals/{id}.txt",
        env="Rdatas/env/makeResiduals_{id}.Rdata"
    input:
        data="Rdatas/preProcess/{id}.rds"
    output:
        residuals="Rdatas/residuals/{id}.rds",
        pca_panel="../data/plots/PCA/pca_panel_{id}.png",
        mean_var="../data/plots/meanVar/meanVar_{id}.png",
        mean_var_resid="../data/plots/meanVar/meanVar_{id}_residual.png",
        all_plots="Rdatas/plots/all_pca_{id}.rds"

    script:
        "scripts/makeResiduals.R"